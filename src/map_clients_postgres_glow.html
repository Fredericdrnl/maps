<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    
            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                #map_4046fb105455edf06d6c0f3f90bc627a {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
</head>
<body>
    
    
<style>
/* ===== MENU CENTR√â ===== */
#topMenu {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 10px 25px;
    border-radius: 12px;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.25);
    z-index: 9999;
    display: flex;
    gap: 15px;
    font-family: Arial, sans-serif;
}
#topMenu button {
    width: 180px;
    height: 42px;
    font-size: 15px;
    font-weight: bold;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s ease;
}
#topMenu button:hover {
    background: #0056b3;
    transform: scale(1.05);
}

/* ===== POPUP ===== */
#popup {
    position: fixed;
    top: 70px;
    right: 10px;
    width: 400px;
    max-height: 600px;
    overflow-y: auto;
    background: white;
    padding: 16px;
    border-radius: 10px;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
    z-index: 9999;
    font-family: Arial, sans-serif;
    transform: translateX(110%);
    opacity: 0;
    transition: transform 0.25s ease, opacity 0.25s ease;
    overflow: hidden;
}
#popup.open {
    transform: translateX(0);
    opacity: 1;
}

/* ===== GLOW ANIM√â ===== */
@keyframes markerGlow {
    0% { filter: drop-shadow(0 0 0px rgba(0,123,255,0.7)); }
    50% { filter: drop-shadow(0 0 15px rgba(0,123,255,0.9)); }
    100% { filter: drop-shadow(0 0 0px rgba(0,123,255,0.7)); }
}
.highlight-marker {
    animation: markerGlow 1.2s infinite;
}

/* ===== AUTO-SUGGESTION ===== */
.suggestions {
    border: 1px solid #ccc;
    background: #fff;
    max-height: 180px;
    overflow-y: auto;
    position: absolute;
    z-index: 9999;
    width: 100%;
    font-size: 16px;
    border-radius: 5px;
    margin-top: 0px;
}
.suggestion-item {
    padding: 8px;
    cursor: pointer;
}
.suggestion-item:hover {
    background-color: #e9ecef;
}
input[type=checkbox] {
    width: 20px;
    height: 20px;
    margin-right: 6px;
    transform: scale(1.2);
}
input {
        margin-bottom: 10px;
}

h5 {
    font-size: 18px;
    font-weight: bold;
}
</style>

<div id="topMenu">
<button id="searchBtn">üîç Recherche client</button>
<button id="createBtn">‚ûï Cr√©er client</button>
</div>
<div id="popup"></div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.4/leaflet.awesome-markers.js"></script>

<script>
var map = null;
var allClients = [];
var markers = [];

function getMap(){ for(var k in window) if(k.startsWith("map_")) return window[k]; return null; }

async function loadClients() {
    try {
        const res = await fetch("http://127.0.0.1:5000/clients");
        const data = await res.json();
        allClients = data;
        displayAllMarkers();
    } catch(err){ console.error("Erreur chargement clients:", err); }
}

function displayAllMarkers(){
    if(!map) map = getMap();
    markers.forEach(mObj => { 
        if(map.hasLayer(mObj.marker)) map.removeLayer(mObj.marker); 
        mObj.marker.getElement()?.classList.remove("highlight-marker");
    });
    markers = [];

    allClients.forEach(c => {
        if(!c.latitude || !c.longitude) return;
        const icon = L.AwesomeMarkers.icon({icon:'info-sign', markerColor:c.couleur || 'blue'});
        const marker = L.marker([c.latitude, c.longitude], {icon})
            .bindPopup(`<b>${c.nom_client}</b><br>${c.code_client}<br>${c.jours_livraison}<br>${c.adresse_complete}<br>
                        <button class='delete-btn' data-id='${c.id}'>Supprimer</button>`);
        marker.addTo(map);
        markers.push({marker, client:c});
    });
}

function updateHighlight(filters){
    const {jours, nom, code} = filters;
    markers.forEach(mObj => {
        const {marker, client} = mObj;
        const matchJour = jours.length===0 || jours.some(j=>client.jours_livraison.includes(j));
        const matchNom = nom ? client.nom_client.toLowerCase().includes(nom.toLowerCase()) : true;
        const matchCode = code ? client.code_client.toLowerCase().includes(code.toLowerCase()) : true;
        const visible = matchJour && matchNom && matchCode;

        if(visible){
            if(!map.hasLayer(marker)) marker.addTo(map);
            marker.getElement()?.classList.add("highlight-marker"); // glow activ√©
        } else {
            if(map.hasLayer(marker)) map.removeLayer(marker);
            marker.getElement()?.classList.remove("highlight-marker"); // glow d√©sactiv√©
        }
    });
}

async function deleteClient(id){
    if(!confirm("Supprimer ce client ?")) return;
    await fetch("http://127.0.0.1:5000/clients/"+id,{method:"DELETE"});
    loadClients();
}

function openPopup(html){ const p = document.getElementById("popup"); p.innerHTML=html; p.classList.add("open"); }
function closePopup(){ document.getElementById("popup").classList.remove("open"); }

function getCurrentFilters(){
    const popup = document.getElementById("popup");
    const jours = Array.from(popup.querySelectorAll("input[type=checkbox]:checked")).map(c=>c.value);
    const nom = popup.querySelector("#nameSearch")?.value || "";
    const code = popup.querySelector("#codeSearch")?.value || "";
    return {jours, nom, code};
}

function showSuggestions(inputEl, field, containerId){
    const query = inputEl.value.toLowerCase();
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    if(query.length<1) return;
    const matches = allClients.filter(c => c[field].toLowerCase().includes(query)).slice(0,8);
    matches.forEach(c=>{
        const div = document.createElement("div");
        div.className="suggestion-item";
        div.textContent=`${c.nom_client} (${c.code_client})`;
        div.onclick=()=>{
            inputEl.value = c[field];
            container.innerHTML="";
            map.setView([c.latitude,c.longitude],14);
            markers.forEach(m => {
                if(m.client.id === c.id) m.marker.openPopup();
            });
            updateHighlight(getCurrentFilters());
        };
        container.appendChild(div);
    });
}

document.addEventListener("DOMContentLoaded",()=>{
    map = getMap();
    loadClients();

    document.getElementById("searchBtn").onclick = ()=>{
        const jours=['L','M','W','J','V','S','D'];
        const html = `
            <h4>üîç Recherche client</h4>
            <input id='nameSearch' placeholder='Nom client' style='width:95%; margin-bottom:8px;'>
            <div id='suggestionsNom' class='suggestions'></div>
            <input id='codeSearch' placeholder='Code client' style='width:95%; margin-bottom:12px;'>
            <div id='suggestionsCode' class='suggestions'></div>
            <h5>üìÖ Jours de livraison</h5>
            ${jours.map(j=>`<label><input type='checkbox' value='${j}' checked> ${j}</label><br>`).join("")}
            <div id='clientCount'></div>
            <br><button id='closePopup'>Fermer</button>`;
        openPopup(html);

        const popup = document.getElementById("popup");
        const update = ()=>updateHighlight(getCurrentFilters());
        popup.querySelectorAll("input[type=checkbox]").forEach(i=>i.addEventListener("change", update));
        popup.querySelector("#nameSearch").addEventListener("input", ()=>{ showSuggestions(popup.querySelector("#nameSearch"), "nom_client","suggestionsNom"); update(); });
        popup.querySelector("#codeSearch").addEventListener("input", ()=>{ showSuggestions(popup.querySelector("#codeSearch"), "code_client","suggestionsCode"); update(); });
        popup.querySelector("#closePopup").onclick = closePopup;

        update(); // applique filtre initial
    };

    document.getElementById("createBtn").onclick = ()=>{
        const html = `
            <h4>‚ûï Cr√©er un client</h4>
            <input id='code_client' placeholder='Code client' style='width:95%;'>
            <input id='nom_client' placeholder='Nom client' style='width:95%;'>
            <input id='jours_livraison' placeholder='Jours (ex: LMV)' style='width:95%;'>
            <input id='adresse_complete' placeholder='Adresse' style='width:95%;'>
            <input id='longitude' placeholder='Longitude' style='width:95%;'>
            <input id='latitude' placeholder='Latitude' style='width:95%;'>
            <input id='couleur' placeholder='Couleur' style='width:95%;'>
            <input id='tournee' type='number' placeholder='Tourn√©e' style='width:95%;'>
            <button id='saveBtn'>Enregistrer</button>
            <button id='closePopup'>Fermer</button>`;
        openPopup(html);

        const popup = document.getElementById("popup");
        popup.querySelector("#saveBtn").onclick = async ()=>{
            const c = {
                code_client: popup.querySelector("#code_client").value,
                nom_client: popup.querySelector("#nom_client").value,
                jours_livraison: popup.querySelector("#jours_livraison").value,
                adresse_complete: popup.querySelector("#adresse_complete").value,
                longitude: parseFloat(popup.querySelector("#longitude").value),
                latitude: parseFloat(popup.querySelector("#latitude").value),
                couleur: popup.querySelector("#couleur").value || "blue",
                tournee: parseInt(popup.querySelector("#tournee").value)||0
            };
            await fetch("http://127.0.0.1:5000/clients",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});
            closePopup(); loadClients();
        };
        popup.querySelector("#closePopup").onclick = closePopup;
    };

    document.addEventListener("click", e=>{
        if(e.target.matches(".delete-btn")) deleteClient(e.target.dataset.id);
    });
});
</script>
    
            <div class="folium-map" id="map_4046fb105455edf06d6c0f3f90bc627a" ></div>
        
</body>
<script>
    
    
            var map_4046fb105455edf06d6c0f3f90bc627a = L.map(
                "map_4046fb105455edf06d6c0f3f90bc627a",
                {
                    center: [50.6, 3.0],
                    crs: L.CRS.EPSG3857,
                    ...{
  "zoom": 7,
  "zoomControl": true,
  "preferCanvas": false,
}

                }
            );

            

        
    
            var tile_layer_cbe7329ee624c5044ae6104047f053b9 = L.tileLayer(
                "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
  "minZoom": 0,
  "maxZoom": 19,
  "maxNativeZoom": 19,
  "noWrap": false,
  "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
  "subdomains": "abc",
  "detectRetina": false,
  "tms": false,
  "opacity": 1,
}

            );
        
    
            tile_layer_cbe7329ee624c5044ae6104047f053b9.addTo(map_4046fb105455edf06d6c0f3f90bc627a);
        
</script>
</html>